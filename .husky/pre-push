#!/usr/bin/env sh

# Exit on any error
set -e

# Ensure commands run from repository root
cd -- "$(dirname -- "$0")/.."

echo "üê∂ Husky pre-push: Validating lockfile"

# Check if package.json files changed without corresponding yarn.lock update
echo "üîí Checking lockfile sync..."

# Get list of files being pushed (compare against remote)
REMOTE_REF="origin/$(git rev-parse --abbrev-ref HEAD)"
if git rev-parse --verify "$REMOTE_REF" >/dev/null 2>&1; then
  # Check if any package.json files changed in commits being pushed
  CHANGED_PACKAGES=$(git diff --name-only "$REMOTE_REF"..HEAD | grep -E 'package\.json$' || true)

  if [ -n "$CHANGED_PACKAGES" ]; then
    echo "üì¶ Detected package.json changes, validating lockfile..."

    # Run yarn install in lockfile-only mode to check if it's in sync
    if ! yarn install --immutable 2>/dev/null; then
      echo ""
      echo "‚ùå Lockfile is out of sync with package.json changes!"
      echo ""
      echo "   Changed package.json files:"
      echo "$CHANGED_PACKAGES" | sed 's/^/     - /'
      echo ""
      echo "   Please run: yarn install"
      echo "   Then commit the updated yarn.lock file."
      echo ""
      exit 1
    fi

    echo "‚úÖ Lockfile is in sync"
  fi
fi

echo "‚úÖ Pre-push validation complete"
